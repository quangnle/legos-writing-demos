<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proof of work demo</title>
    <style>
        :root {
            --color-bg: #0f1419;
            --color-surface: #1a2332;
            --color-surface-elevated: #243044;
            --color-border: #2d3d52;
            --color-text: #e6edf3;
            --color-text-muted: #8b9cb3;
            --color-primary: #58a6ff;
            --color-primary-hover: #79b8ff;
            --color-success: #3fb950;
            --color-pending: #d29922;
            --color-error: #f85149;
            --font-sans: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-mono: 'Consolas', 'Monaco', monospace;
            --radius: 8px;
            --radius-sm: 4px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            font-size: 15px;
            line-height: 1.5;
            color: var(--color-text);
            background: var(--color-bg);
            margin: 0;
            padding: 2rem 1rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
        }

        .header h1 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .layout {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .tx-row {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 1.5rem;
            align-items: start;
        }

        @media (max-width: 768px) {
            .tx-row { grid-template-columns: 1fr; }
        }

        .section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: var(--shadow);
        }

        .section h2 {
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text-muted);
        }

        /* Form */
        .tx-form {
            display: flex;
            flex-wrap: nowrap;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .form-group label {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        input, button {
            font-family: inherit;
            font-size: 0.9rem;
        }

        input[type="text"] {
            padding: 0.4rem 0.5rem;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text);
            width: 72px;
        }

        input[type="number"] {
            padding: 0.4rem 0.5rem;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text);
            width: 52px;
        }

        input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        button {
            padding: 0.5rem 1rem;
            background: var(--color-primary);
            color: #fff;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            background: var(--color-primary-hover);
        }

        /* Transactions list */
        .tx-list-wrapper {
            height: 220px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .tx-list-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .tx-list-wrapper::-webkit-scrollbar-track {
            background: var(--color-surface-elevated);
            border-radius: 3px;
        }

        .tx-list-wrapper::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 3px;
        }

        .tx-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .tx-list li {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--color-surface-elevated);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--color-border);
            font-size: 0.9rem;
        }

        .tx-list li.verified {
            border-left-color: var(--color-success);
        }

        .tx-list li .status {
            font-size: 1rem;
        }

        .tx-list li .status.verified { color: var(--color-success); }
        .tx-list li .status.pending { color: var(--color-error); }

        /* Mining section */
        .mining-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .mining-blocks {
            display: flex;
            flex-wrap: nowrap;
            gap: 1rem;
            list-style: none;
            margin: 0;
            padding: 0.5rem 0;
            overflow-x: auto;
            min-height: 200px;
        }

        .mining-blocks::-webkit-scrollbar {
            height: 6px;
        }

        .mining-blocks::-webkit-scrollbar-track {
            background: var(--color-surface-elevated);
            border-radius: 3px;
        }

        .mining-blocks::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 3px;
        }

        /* Block card */
        .block-card {
            flex: 0 0 280px;
            padding: 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--color-border);
            background: var(--color-surface-elevated);
            transition: background 0.2s, border-color 0.2s;
        }

        .block-card.pending {
            border-color: var(--color-pending);
            background: rgba(210, 153, 34, 0.08);
        }

        .block-card.mined {
            border-color: var(--color-success);
            background: rgba(63, 185, 80, 0.08);
        }

        .block-card h3 {
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .block-card .field {
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .block-card .field-label {
            color: var(--color-text-muted);
            display: block;
            margin-bottom: 0.15rem;
        }

        .block-card .hash {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            word-break: break-all;
            color: var(--color-text-muted);
        }

        .block-card .txs-in-block {
            list-style: none;
            margin: 0.25rem 0;
            padding: 0;
            font-size: 0.8rem;
        }

        .block-card .txs-in-block li {
            padding: 0.2rem 0;
            border-bottom: 1px solid var(--color-border);
        }

        .block-card .txs-in-block li:last-child {
            border-bottom: none;
        }

        .block-card .mine-btn {
            margin-top: 0.75rem;
        }

        .block-card .mined-badge {
            display: inline-block;
            margin-top: 0.75rem;
            color: var(--color-success);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Proof of work demo</h1>
        </header>

        <div class="layout">
            <div class="tx-row">
                <section class="section">
                    <h2>New transaction</h2>
                    <div class="tx-form">
                        <div class="form-group">
                            <label for="from">From</label>
                            <input type="text" id="from" value="Alice">
                        </div>
                        <div class="form-group">
                            <label for="to">To</label>
                            <input type="text" id="to" value="Bob">
                        </div>
                        <div class="form-group">
                            <label for="value">Value</label>
                            <input type="number" id="value" value="100">
                        </div>
                        <button onclick="createTx()">Create transaction</button>
                    </div>
                </section>

                <section class="section">
                    <h2>Transactions</h2>
                    <div class="tx-list-wrapper">
                        <ul id="transactions" class="tx-list"></ul>
                    </div>
                </section>
            </div>

            <section class="section mining-section">
                <div class="mining-header">
                    <h2>Mining</h2>
                    <button onclick="createANewBlock()">Create a new block</button>
                </div>
                <ul id="mining-blocks" class="mining-blocks"></ul>
            </section>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <script>
        const transactions = [];
        const accounts = ['Alice', 'Bob', 'Charlie', 'David', 'Eve', 'Frank', 'Grace', 'Helen', 'Ivy', 'Jack'];

        generateTx();

        function generateTx(){
            // fill in random values for from, to, value
            let frAcc = accounts[Math.floor(Math.random() * accounts.length)];            
            let toAcc = accounts[Math.floor(Math.random() * accounts.length)];

            // make sure from and to are different
            while(frAcc == toAcc){
                toAcc = accounts[Math.floor(Math.random() * accounts.length)];
            }
            document.getElementById('from').value = frAcc;
            document.getElementById('to').value = toAcc;

            // fill in random value
            let val = Math.floor(Math.random() * 100);
            document.getElementById('value').value = val;
        }
        
        function createTx() {
            const from = document.getElementById('from').value;
            const to = document.getElementById('to').value;
            const value = document.getElementById('value').value;
            const tx = { id: (transactions.length + 1), from, to, value, verified: false };
            transactions.push(tx);
            renderTransactions();

            generateTx();
        }

        function renderTransactions() {
            const txs = document.getElementById('transactions');
            txs.innerHTML = '';
            transactions.forEach(tx => {
                const li = document.createElement('li');
                li.id = `tx-${tx.id}`;
                if (tx.verified) li.classList.add('verified');
                const statusClass = tx.verified ? 'verified' : 'pending';
                li.innerHTML = `<span class="status ${statusClass}">${tx.verified ? '&#10004;' : '&#10008;'}</span> ${tx.id}: ${tx.from} &rarr; ${tx.to} : ${tx.value}`;
                txs.appendChild(li);
            });
        }

        const blocks = [];
        async function generateABlock(){
            let blockId = blocks.length;
            // random select 3 transactions that are not yet verified
            let txs = transactions.filter(tx => !tx.verified);
            let selectedTxs = [];
            let maxTxs = Math.min(3, txs.length);
            for(let i = 0; i < maxTxs; i++){
                let idx = Math.floor(Math.random() * txs.length);
                selectedTxs.push(txs[idx]);
                txs.splice(idx, 1);
            }            
            let block = { id: blockId, transactions: selectedTxs, prevHash: 0, hash: 0, nonce: 0 };
            if (blockId > 0) {
                block.prevHash = blocks[blockId - 1].hash;
            }
            // hash all the block's content
            let content = getBlockContent(block);
            block.hash = await sha256(content + block.nonce);

            return block;          
        }

        async function createANewBlock(){
            let unverifiedTxs = transactions.filter(tx => !tx.verified);
            if (unverifiedTxs.length == 0) return;

            if (blocks.length > 0 && !blocks[blocks.length - 1].hash.startsWith('0000') && unverifiedTxs.length > 0) {
                //remove the last block if it's not mined yet
                blocks.pop();
            }

            let block = await generateABlock();
            blocks.push(block);
            renderBlocks();
        }

        function getBlockContent(block){
            return block.id + block.transactions.map(tx => tx.id + tx.from + tx.to + tx.value).join('') + block.prevHash;
        }

        function generateBlockContent(block){
            const li = document.createElement('li');
            li.id = `block-${block.id}`;
            li.className = 'block-card ' + (block.hash.startsWith('0000') ? 'mined' : 'pending');
            const blockTemplate = `
                <h3>Block ${block.id}</h3>
                <div class="field">
                    <span class="field-label">Block Hash</span>
                    <div class="hash">${block.hash}</div>
                </div>
                <div class="field">
                    <span class="field-label">Previous Hash</span>
                    <div class="hash">${block.prevHash}</div>
                </div>
                <div class="field">
                    <span class="field-label">Transactions</span>
                    <ul class="txs-in-block">
                    ${block.transactions.map(tx => `<li>${tx.id}: ${tx.from} &rarr; ${tx.to} : ${tx.value}</li>`).join('')}
                    </ul>
                </div>
                <div class="field">Nonce: ${block.nonce}</div>
                ${!block.hash.startsWith('0000') ? `<button class="mine-btn" onclick="mineABlock(${block.id})">Mine</button>` : '<span class="mined-badge">&#10004; Mined</span>'}
            `;
            li.innerHTML = blockTemplate;
            return li;
        }

        async function renderBlocks() {
            const ul = document.getElementById('mining-blocks');
            ul.innerHTML = '';
            blocks.forEach(block => {
                const li = generateBlockContent(block);
                verifyABlock(block).then(verified => {
                    if (verified) li.classList.add('mined');
                });
                ul.appendChild(li);
            });
        } 

        async function mineABlock(id) {
            const block = blocks.find(b => b.id === id);
            if (block.id > 0) {
                block.prevHash = blocks[block.id - 1].hash;
            }
            const difficulty = 4;
            const prefix = '0'.repeat(difficulty);
            let hash = '';
            let nonce = 0;
            let content = getBlockContent(block);
            while (!hash.startsWith(prefix)) {
                nonce++;
                hash = await sha256(content + nonce);
                //console.log(nonce, hash);
            }
            block.nonce = nonce;
            block.hash = hash;
            block.transactions.forEach(tx => tx.verified = true);

            const li = document.getElementById(`block-${block.id}`);
            li.innerHTML = generateBlockContent(block).innerHTML;
            li.className = 'block-card mined';

            // update transactions
            renderTransactions();
        }

        async function verifyABlock(block) {
            const difficulty = 4;
            const prefix = '0'.repeat(difficulty);
            let content = getBlockContent(block);
            let hash = await sha256(content + block.nonce);
            return hash.startsWith(prefix);
        }

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
    </script>
</body>
</html>