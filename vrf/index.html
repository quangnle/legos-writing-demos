<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minh Họa VRF (RSA)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 15px;
            background-color: #f4f7f6;
        }
        .container {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #0056b3;
            border-bottom: 2px solid #eef;
            padding-bottom: 10px;
        }
        input[type="number"], input[type="text"] {
            width: 100px;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        .results, .calculation-steps {
            margin-top: 15px;
            padding: 15px;
            background-color: #eef7ff;
            border: 1px solid #bce8f1;
            border-radius: 4px;
        }
        .results code, .calculation-steps code {
            font-family: "Courier New", Courier, monospace;
            background-color: #d4eaff;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        .error {
            color: #d9534f;
            font-weight: bold;
        }
        .success {
            color: #28a745;
            font-weight: bold;
            font-size: 1.2em;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <h1>Minh Họa Hàm Ngẫu Nhiên Có Thể Kiểm Chứng (VRF)</h1>

    <!-- Phần 1: Tạo Khóa -->
    <div class="container">
        <h2>1. Tạo Khóa</h2>
        <p>Nhập vào hai số nguyên tố (p và q) để tạo Khóa Công Khai và Khóa Bí Mật. Ví dụ: 13, 17 hoặc 23, 29.</p>
        <div>
            <label for="p">p = </label>
            <input type="number" id="p" value="13">
            <label for="q">q = </label>
            <input type="number" id="q" value="17">
        </div>
        <button id="generateKeysBtn" style="margin-top: 10px;">Tạo Khóa</button>
        <div id="keyResults"></div>
        <div id="keyCalcSteps" class="calculation-steps hidden"></div>
    </div>

    <!-- Phần 2: Tạo Bằng Chứng -->
    <div class="container hidden" id="proofSection">
        <h2>2. Tạo Bằng Chứng và Giá Trị Ngẫu Nhiên</h2>
        <p>Nhập vào một chuỗi dữ liệu bất kỳ (input) để tạo bằng chứng.</p>
        <div>
            <label for="alpha">Input (alpha) = </label>
            <input type="text" id="alpha" value="hello world" style="width: 200px;">
        </div>
        <button id="generateProofBtn" style="margin-top: 10px;">Tạo Bằng Chứng</button>
        <div id="proofResults"></div>
        <div id="proofCalcSteps" class="calculation-steps hidden"></div>
    </div>

    <!-- Phần 3: Kiểm Chứng -->
    <div class="container hidden" id="verificationSection">
        <h2>3. Kiểm Chứng</h2>
        <p>Nhấn nút để kiểm tra xem bằng chứng và giá trị ngẫu nhiên có hợp lệ với Khóa Công Khai hay không.</p>
        <button id="verifyBtn">Kiểm Chứng</button>
        <div id="verificationResult"></div>
        <div id="verifyCalcSteps" class="calculation-steps hidden"></div>
    </div>

    <script>
        // Các biến toàn cục để lưu trạng thái
        let p, q, N, phi, e, d, m, pi, y, alpha;

        // Hàm kiểm tra số nguyên tố (đơn giản)
        function isPrime(num) {
            if (num <= 1) return false;
            if (num <= 3) return true;
            if (num % 2 === 0 || num % 3 === 0) return false;
            for (let i = 5; i * i <= num; i = i + 6) {
                if (num % i === 0 || num % (i + 2) === 0) return false;
            }
            return true;
        }

        // Hàm tìm ước chung lớn nhất (GCD)
        function gcd(a, b) {
            while (b) {
                [a, b] = [b, a % b];
            }
            return a;
        }
        
        // Hàm tìm nghịch đảo modular (Extended Euclidean Algorithm)
        function modInverse(a, m) {
            let m0 = m, t, q;
            let x0 = 0, x1 = 1;
            if (m === 1) return 0;
            while (a > 1) {
                q = Math.floor(a / m);
                t = m;
                m = a % m, a = t;
                t = x0;
                x0 = x1 - q * x0;
                x1 = t;
            }
            if (x1 < 0) x1 += m0;
            return x1;
        }

        // Hàm tính lũy thừa modular: (base^exp) % mod
        function power(base, exp, mod) {
            let res = 1;
            base %= mod;
            while (exp > 0) {
                if (exp % 2 === 1) res = (res * base) % mod;
                exp >>= 1; // Tương đương exp = exp / 2
                base = (base * base) % mod;
            }
            return res;
        }
        
        // Hàm tìm e phù hợp
        function findE(phi) {
            // Bắt đầu kiểm tra từ một số mũ công khai phổ biến
            let e = 3;
            // Lặp cho đến khi tìm được e nguyên tố cùng nhau với phi
            while (gcd(e, phi) !== 1) {
                e += 2; // Kiểm tra số lẻ tiếp theo
            }
            return e;
        }

        // Hàm băm đơn giản theo yêu cầu
        function customHash(str) {
            let sum = 0;
            for (let i = 0; i < str.length; i++) {
                sum += str.charCodeAt(i);
            }
            return sum % N;
        }


        // --- CÁC HÀM XỬ LÝ SỰ KIỆN ---

        document.getElementById('generateKeysBtn').addEventListener('click', generateKeys);
        document.getElementById('generateProofBtn').addEventListener('click', generateProof);
        document.getElementById('verifyBtn').addEventListener('click', verify);

        function generateKeys() {
            const p = parseInt(document.getElementById('p').value);
            const q = parseInt(document.getElementById('q').value);

            const keyResultsDiv = document.getElementById('keyResults');
            const keyCalcStepsDiv = document.getElementById('keyCalcSteps');
            keyResultsDiv.innerHTML = '';
            keyCalcStepsDiv.innerHTML = '';
            
            // Validation
            if (!p || !q) {
                keyResultsDiv.innerHTML = '<p class="error">Vui lòng nhập cả p và q.</p>';
                return;
            }
            if (!isPrime(p) || !isPrime(q)) {
                keyResultsDiv.innerHTML = '<p class="error">p và q phải là số nguyên tố.</p>';
                return;
            }
            if (p === q) {
                keyResultsDiv.innerHTML = '<p class="error">p và q phải khác nhau.</p>';
                return;
            }

            N = p * q;
            phi = (p - 1) * (q - 1);
            
            // Tìm một giá trị e phù hợp
            e = findE(phi);

            d = modInverse(e, phi);

            // Hiển thị kết quả
            keyResultsDiv.innerHTML = `
                <div class="results">
                    <p><strong>Khóa Công Khai (PK):</strong> {N=${N}, e=${e}}</p>
                    <p><strong>Khóa Bí Mật (SK):</strong> {d=${d}}</p>
                </div>
            `;

            // Hiển thị các bước tính toán
            keyCalcStepsDiv.innerHTML = `
                <h4>Các bước tính toán khóa:</h4>
                <ol>
                    <li>Tính <strong>N</strong> = p * q = ${p} * ${q} = <code>${N}</code>.</li>
                    <li>Tính <strong>φ(N)</strong> = (p-1) * (q-1) = ${p-1} * ${q-1} = <code>${phi}</code>.</li>
                    <li>Tìm một số <strong>e</strong> sao cho 1 < e < φ(N) và e nguyên tố cùng nhau với φ(N). Ta tìm được e = <code>${e}</code>.</li>
                    <li>Tính <strong>d</strong> sao cho d * e ≡ 1 (mod φ(N)), tức là d * ${e} ≡ 1 (mod ${phi}). Kết quả d = <code>${d}</code>.</li>
                </ol>
            `;
            keyCalcStepsDiv.classList.remove('hidden');
            
            document.getElementById('proofSection').classList.remove('hidden');
            document.getElementById('verificationSection').classList.add('hidden');
            document.getElementById('proofResults').innerHTML = '';
            document.getElementById('proofCalcSteps').classList.add('hidden');
        }

        function generateProof() {
            alpha = document.getElementById('alpha').value;
            const proofResultsDiv = document.getElementById('proofResults');
            const proofCalcStepsDiv = document.getElementById('proofCalcSteps');
            proofResultsDiv.innerHTML = '';
            proofCalcStepsDiv.innerHTML = '';
            
            if (!alpha) {
                proofResultsDiv.innerHTML = '<p class="error">Vui lòng nhập chuỗi input.</p>';
                return;
            }
            
            // Băm input
            const m = customHash(alpha);

            // Tạo bằng chứng pi
            pi = power(m, d, N);
            
            // Tạo giá trị ngẫu nhiên y
            y = customHash(pi.toString());

            // Hiển thị kết quả
            proofResultsDiv.innerHTML = `
                <div class="results">
                    <p><strong>Bằng chứng (π):</strong> <code>${pi}</code></p>
                    <p><strong>Giá trị ngẫu nhiên (y):</strong> <code>${y}</code></p>
                </div>
            `;

            // Hiển thị các bước tính toán
            proofCalcStepsDiv.innerHTML = `
                <h4>Các bước tạo bằng chứng:</h4>
                <ol>
                    <li>Băm chuỗi input <strong>alpha</strong> = "${alpha}" bằng hàm băm đơn giản: <br>
                        m = Hash(alpha) = (tổng mã ASCII) mod N = <code>${m}</code>.</li>
                    <li>Tạo bằng chứng <strong>π</strong> bằng khóa bí mật (d=${d}): <br>
                        π = m<sup>d</sup> mod N = ${m}<sup>${d}</sup> mod ${N} = <code>${pi}</code>.</li>
                    <li>Tạo giá trị ngẫu nhiên <strong>y</strong> bằng cách băm bằng chứng π: <br>
                        y = Hash(π.toString()) = Hash("${pi}") = <code>${y}</code>.</li>
                </ol>
            `;
            proofCalcStepsDiv.classList.remove('hidden');
            
            document.getElementById('verificationSection').classList.remove('hidden');
            document.getElementById('verificationResult').innerHTML = '';
            document.getElementById('verifyCalcSteps').classList.add('hidden');
        }

        function verify() {
            const verificationResultDiv = document.getElementById('verificationResult');
            const verifyCalcStepsDiv = document.getElementById('verifyCalcSteps');
            
            // Bước 1: Tính m' từ bằng chứng
            const m_prime = power(pi, e, N);

            // Bước 2: Băm lại alpha
            const m_hash = customHash(alpha);

            // Hiển thị các bước tính toán
            let stepsHTML = `
                <h4>Các bước kiểm chứng:</h4>
                <ol>
                    <li>Verifier lấy bằng chứng <strong>π</strong> = ${pi} và Khóa công khai {N=${N}, e=${e}}.</li>
                    <li>Tính giá trị <strong>m'</strong> = π<sup>e</sup> mod N = ${pi}<sup>${e}</sup> mod ${N} = <code>${m_prime}</code>.</li>
                    <li>Verifier tự băm lại input <strong>alpha</strong> = "${alpha}": <br>
                        <strong>m_hash</strong> = Hash("${alpha}") = <code>${m_hash}</code>.</li>
                    <li>So sánh <strong>m'</strong> và <strong>m_hash</strong>.</li>
            `;

            // Bước 3: So sánh và kết luận
            if (m_prime === m_hash) {
                verificationResultDiv.innerHTML = '<p class="success">✅ BẰNG CHỨNG HỢP LỆ</p>';
                stepsHTML += `<li>Kết quả: ${m_prime} == ${m_hash}. Bằng chứng là hợp lệ!</li>`;
                
                // Kiểm tra giá trị ngẫu nhiên y
                const y_prime = customHash(pi.toString());
                stepsHTML += `<li>Kiểm tra giá trị ngẫu nhiên: <br> y' = Hash(π.toString()) = Hash("${pi}") = <code>${y_prime}</code>.</li>`;
                if (y === y_prime) {
                    stepsHTML += `<li>Kết quả: ${y} == ${y_prime}. Giá trị ngẫu nhiên cũng hợp lệ!</li>`;
                } else {
                     stepsHTML += `<li>Kết quả: ${y} != ${y_prime}. Lỗi: Giá trị ngẫu nhiên không khớp!</li>`;
                }

            } else {
                verificationResultDiv.innerHTML = '<p class="error">❌ BẰNG CHỨNG KHÔNG HỢP LỆ</p>';
                stepsHTML += `<li>Kết quả: ${m_prime} != ${m_hash}. Bằng chứng không hợp lệ!</li>`;
            }
            
            stepsHTML += '</ol>';
            verifyCalcStepsDiv.innerHTML = stepsHTML;
            verifyCalcStepsDiv.classList.remove('hidden');
        }

    </script>

</body>
</html>
